{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/chat_general/chat_general.css">
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<div class="container">
    <h2 class="texto-chat">Chat</h2>
    <div id="lista-mensajes" class="chat-messages">
        {% for msg in mensajes %}
        <p class="texto-mensaje"><strong>{{ msg.usuario }} ({{ msg.tipo_usuario }}):</strong> {{ msg.mensaje }}</p>
        {% endfor %}
    </div>
    <input id="mensaje" placeholder="Escribe algo..." class="mensaje"><br>
    <button type="button" onclick="enviar()" class="boton-zona">Enviar</button>
    <button type="button" onclick="window.location.href='/volver/menus'" class="boton-logout">Volver</button>

    <script>
        const socket = io();

        const USUARIO = "{{ usuario }}";
        const TIPO = "{{ tipo }}".toLowerCase();

        console.log("DEBUG Cliente: USUARIO=" + USUARIO + ", TIPO=" + TIPO);

        function enviar() {
            const input = document.getElementById("mensaje");
            const texto = input.value.trim();

            if (!texto) return;

            console.log("Enviando mensaje con tipo:", TIPO);

            socket.emit("mensaje", {
                texto: texto,
                usuario: USUARIO,
                tipo: TIPO
            });

            input.value = "";
        }

        function scrollAlFinal() {
            const chatContainer = document.getElementById("lista-mensajes");
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        socket.on("nuevo_mensaje", function (data) {
            const p = document.createElement("p");
            p.className = "texto-mensaje";
            p.innerHTML = `<strong>${data.usuario} (${data.tipo}):</strong> ${data.texto}`;
            document.getElementById("lista-mensajes").appendChild(p);

            // Scroll automático al final
            scrollAlFinal();
        });

        // Scroll inicial al cargar la página
        window.addEventListener('load', scrollAlFinal);
    </script>
    <img src="/static/Cecytem_(Imagen).jpeg" class="fondo-menu">
</div>

{% endblock %}